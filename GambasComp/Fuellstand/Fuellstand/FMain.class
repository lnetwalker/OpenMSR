' Gambas class file
  PUBLIC MaskImg AS Image
  PUBLIC MaskPic AS Picture
  PUBLIC DrawPic AS Picture
  PUBLIC fillcounter AS Integer
  PUBLIC FillPixel AS Integer
  PUBLIC GetAnalogInputValues AS ReadAnalogInputValues
  PUBLIC MaxValue AS Integer
  
PUBLIC SUB _new()

END

PUBLIC SUB Form_Open()
  DIM x AS Integer
  DIM y AS Integer
  
  MaskPic = Picture.Load("Testmask1.png")
  MaskImg = MaskPic.Image
  ' count the number of black pixels in the mask
  fillcounter = 0
  FOR x = MaskImg.Width TO 0 STEP -1
    FOR y = MaskImg.Height TO 0 STEP -1
      IF MaskImg[x, y] = 0 THEN 
        fillcounter += 1
      ENDIF   
    NEXT 
  NEXT 
  PRINT fillcounter
  GetAnalogInputValues = NEW ReadAnalogInputValues AS "Fuellstand"
  GetAnalogInputValues.SetParam("http://canis:10080/analog/read.html?1", 1)
  MaxValue = 600
  
END

PUBLIC SUB Fuellstand_NewAnalogInputValue(IOGroup AS Integer, Values AS String[])

  DIM i AS Integer
  DIM x AS Integer
  DIM y AS Integer
  
  ' calculate the number of pixels representing the Fillvalue
  FillPixel = Int(fillcounter / MaxValue * Val(Values[1]))
  'PRINT "fillcounter: " & fillcounter & "FillPix: " & FillPixel & "  Values[1]: " & Values[1]
  ' loop over the mask beginning at the bottom
  ' and fill FillPixel Pixels with the fill color
  x = MaskImg.Width
  y = MaskImg.Height
  i = 0
  DrawPic = Picture.Load("Container.png")
  Draw.Begin(DrawPic)
  Draw.ForeColor = Color.Green
  WHILE (i < FillPixel) AND (i < fillcounter) 
    ' its a black pixel here so color it
    IF MaskImg[x, y] = 0 THEN 
      Draw.Point(x, y)
      i += 1
      'PRINT i & " " & x & " " & y
    ENDIF
    ' change coordinates to move the picture upwards   
    IF x >= 0 THEN 
      x -= 1
    ELSE 
      x = MaskImg.Width
      y -= 1
    ENDIF     
  WEND
  Draw.End 
  ' show the filled image
  PictureBox1.Picture = DrawPic
END
